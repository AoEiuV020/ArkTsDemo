import { HarmonyTcpSocketFactory } from 'socket';
import util from '@ohos.util';

@Entry
@Component
struct Index {
  @State message: string = 'Hello World';

  build() {
    RelativeContainer() {
      Text(this.message)
        .id('HelloWorld')
        .fontSize($r('app.float.page_text_font_size'))
        .fontWeight(FontWeight.Bold)
        .alignRules({
          center: { anchor: '__container__', align: VerticalAlign.Center },
          middle: { anchor: '__container__', align: HorizontalAlign.Center }
        })
        .onClick(() => {
          this.message = 'Welcome';
          socketTest();
        })
    }
    .height('100%')
    .width('100%')
  }
}

async function socketTest(): Promise<void> {
  console.log('socketTest');
  let tcpSocket = HarmonyTcpSocketFactory.createSocket();
  await tcpSocket.connect({
    address: '192.168.0.66',
    port: 8888,
    timeout: 2000
  });

  console.log('âœ… æˆåŠŸè¿æ¥åˆ°8888ç«¯å£');

  // å¦‚æœè¿æ¥æˆåŠŸï¼Œå‘é€æµ‹è¯•æ¶ˆæ¯å¹¶ç­‰å¾…å›æ˜¾
  const testMessage = 'Hello Server!';
  const messageBytes = new util.TextEncoder().encode(testMessage);

  // åˆ›å»ºPromiseç­‰å¾…å›æ˜¾æ•°æ®
  const echoPromise = new Promise<string>((resolve, reject) => {
    const timeout = setTimeout(() => {
      reject(new Error('ç­‰å¾…å›æ˜¾è¶…æ—¶'));
    }, 3000);

    tcpSocket.on('message', (data: Uint8Array) => {
      clearTimeout(timeout);
      const echoText = new util.TextDecoder().decode(data);
      console.log('ğŸ“¨ æ”¶åˆ°å›æ˜¾æ•°æ®:', echoText);
      resolve(echoText);
    });
  });

  await tcpSocket.send(messageBytes);
  console.log('ğŸ“¤ å‘é€æ¶ˆæ¯:', testMessage);

  const echoText = await echoPromise;
  console.log('âœ… æ”¶åˆ°å›æ˜¾:', echoText);

  await tcpSocket.close();

}