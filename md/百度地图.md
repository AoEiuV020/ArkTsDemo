# 百度地图SDK集成指南

## AK申请

1. 前往 [百度地图开放平台](https://lbs.baidu.com/apiconsole/key)
2. 创建应用，选择"鸿蒙应用"类型
3. 填写包名（与bundleName一致）
4. 将AK替换到 `EntryAbility.ets` 的 `BAIDU_MAP_AK` 常量

## 依赖配置

oh-package.json5中添加（分体包，按需引入）：
```json
"dependencies": {
  "@bdmap/base": "2.0.3",
  "@bdmap/map": "2.0.3",
  "@bdmap/search": "2.0.3"
}
```

模块说明：
- `@bdmap/base` - 基础库（LatLng、Initializer等）
- `@bdmap/map` - 地图显示（MapComponent、Marker等）
- `@bdmap/search` - 检索服务（GeoCoder、PoiSearch等）

## 权限配置

module.json5中添加：
```json
"requestPermissions": [
  { "name": "ohos.permission.LOCATION", "reason": "$string:location_reason", "usedScene": { "when": "inuse" } },
  { "name": "ohos.permission.APPROXIMATELY_LOCATION", "reason": "$string:location_reason", "usedScene": { "when": "inuse" } },
  { "name": "ohos.permission.INTERNET" },
  { "name": "ohos.permission.GET_BUNDLE_INFO" }
]
```

## SDK初始化

在Ability的onWindowStageCreate中初始化：
```typescript
import { Initializer } from '@bdmap/base'

onWindowStageCreate(windowStage: window.WindowStage): void {
  Initializer.getInstance().initialize(BAIDU_MAP_AK, this.context)
  // ...
}
```

## 核心组件

### MapComponent - 地图显示

```typescript
import { LatLng } from '@bdmap/base'
import { MapComponent, MapController, MapOptions, MapStatus } from '@bdmap/map'

MapComponent({
  onReady: (err, controller) => {
    if (!err) this.mapController = controller
  },
  mapOptions: new MapOptions({
    mapStatus: new MapStatus({ zoom: 16, center: new LatLng(39.9, 116.4) })
  })
})
```

### 地图控制

```typescript
// 移动中心点
this.mapController?.setMapCenter(new LatLng(lat, lng), zoom)
// 通过mapStatus
this.mapController?.mapStatus.setCenterPoint(new LatLng(lat, lng)).refresh()
// 获取中心点
const center = this.mapController?.mapStatus.getCenterPoint()
// 设置缩放/旋转/俯视
this.mapController?.mapStatus.setLevel(zoom).setRotate(angle).setOverlooking(overlook).refresh()
```

### 地图类型

```typescript
import { SysEnum, MapLanguage } from "@bdmap/map"

this.mapController?.setMapType(SysEnum.MapType.MAP_TYPE_NORMAL)   // 普通图
this.mapController?.setMapType(SysEnum.MapType.MAP_TYPE_SATELLITE) // 卫星图
this.mapController?.setMapType(SysEnum.MapType.MAP_TYPE_NONE)      // 空白图
this.mapController?.setDEMEnable(true)  // 地形图
this.mapController?.setMapLanguage(MapLanguage.ENGLISH) // 英文地图
```

## 覆盖物

### Marker标记

```typescript
import { LatLng } from '@bdmap/base'
import { Marker, ImageEntity, SysEnum, OverlayEvent } from "@bdmap/map"

const marker = new Marker({
  position: new LatLng(39.9, 116.4),
  icon: new ImageEntity("rawfile://map_marker_red.png"),
  located: SysEnum.Located.TOP,  // 锚点：TOP/CENTER/BOTTOM
  isJoinCollision: SysEnum.CollisionBehavior.NOT_COLLIDE,
  scaleX: 1.5,  // 缩放
  scaleY: 1.5,
  isFixed: false,  // 是否固定在屏幕位置
  zIndex: 10
})
this.mapController?.addOverlay(marker)

// 点击事件
marker.addEventListener(OverlayEvent.CLICK, () => {
  marker.remove()
})

// 移除
this.mapController?.removeOverlay(marker)
this.mapController?.removeOverlays(SysEnum.OverlayType.MARKER) // 移除所有Marker
this.mapController?.removeOverlays() // 移除所有覆盖物
```

### Circle圆形

```typescript
import { LatLng } from '@bdmap/base'
import { Circle, Stroke, SysEnum } from "@bdmap/map"

const circle = new Circle({
  center: new LatLng(39.9, 116.4),
  radius: 1000,  // 米
  fillcolor: '#95d0db2a',
  stroke: new Stroke({
    strokeWidth: 3,
    color: '#ffff00e5',
    strokeStyle: SysEnum.StrokeStyle.REAL
  })
})
this.mapController?.addOverlay(circle)
```

## 定位图层

```typescript
import { LatLng } from '@bdmap/base'
import { ILocation, LocationLayer, SysEnum } from "@bdmap/map"

const myLocation: ILocation = {
  latlng: new LatLng(39.9, 116.4),
  direction: 90,  // 方向角度
  radius: 1000    // 精度范围
}

// 设置定位信息
this.mapController?.setLocationInfo(myLocation, {
  locationMode: SysEnum.LocationMode.NORMAL     // 普通模式
  // SysEnum.LocationMode.FOLLOWING  // 跟随模式
  // SysEnum.LocationMode.COMPASS    // 罗盘模式
})

// 获取定位图层
const layer = this.mapController?.getLayerByTag(SysEnum.LayerTag.LOCATION) as LocationLayer
layer?.setVisible(false)  // 隐藏定位图层
```

## 搜索功能

### 地理编码（地址转坐标）

```typescript
import { GeoCoder, GeoCodeOption, GeoCodeResult } from "@bdmap/search"

const geocoder = GeoCoder.newInstance()
const option = new GeoCodeOption("北京", "上地十街10号")
geocoder.geocode(option).then((res: GeoCodeResult) => {
  // res.location - LatLng坐标
})
```

### 逆地理编码（坐标转地址）

```typescript
import { LatLng } from '@bdmap/base'
import { GeoCoder, ReverseGeoCodeOption, ReverseGeoCodeResult } from "@bdmap/search"

const geocoder = GeoCoder.newInstance()
const option = new ReverseGeoCodeOption({
  location: new LatLng(lat, lng),
  radius: 500,   // 附近POI半径
  pageNum: 0
})
geocoder.reverseGeoCode(option).then((res: ReverseGeoCodeResult) => {
  // res.location - 位置
  // res.poiList - 附近POI列表
  // res.adcode - 行政区划代码
  // res.poiList[0].name - 地名
  // res.poiList[0].address - 地址
})
```

### 周边POI搜索

```typescript
import { LatLng } from '@bdmap/base'
import { PoiSearch, PoiNearbySearchOption, PoiResult, PoiInfo } from "@bdmap/search"

const search = PoiSearch.newInstance()
const option = new PoiNearbySearchOption({
  keyword: "餐厅",
  location: new LatLng(39.9, 116.4),
  radius: 1000,
  scope: 2,        // 1简略 2详细
  radiusLimit: true, // 限制在半径内
  pageNum: 0
})
search.searchNearby(option).then((res: PoiResult) => {
  // res.arrayPoiInfo - POI列表
  // res.totalPageNum - 总页数
  // res.currentPageNum - 当前页
  res.arrayPoiInfo?.forEach((poi: PoiInfo) => {
    // poi.name - 名称
    // poi.address - 地址
    // poi.location - 坐标
    // poi.poiDetailInfo - 详细信息
  })
})
```

### 输入联想

```typescript
import { LatLng } from '@bdmap/base'
import { SuggestionSearch, SuggestionSearchOption, SuggestionResult, SuggestionInfo } from "@bdmap/search"

const search = SuggestionSearch.newInstance()
search.requestSuggestion({
  city: "北京",
  keyword: "大学",
  hotWord: true,
  location: new LatLng(0, 0)
}).then((res: SuggestionResult) => {
  res.suggestionList?.forEach((item: SuggestionInfo) => {
    // item.key - 关键词
    // item.city - 城市
    // item.district - 区县
    // item.location - 坐标
  })
})
```

## 事件监听

### 地图点击

```typescript
import { MapEvent, EventBundle } from "@bdmap/map"

controller.addEventListener(MapEvent.CLICK, (event) => {
  const geo = (event as EventBundle).geo // LatLng
})
controller.addEventListener(MapEvent.LONGPRESS, (event) => {})
controller.addEventListener(MapEvent.DOUBLECLICK, (event) => {})
```

### 地图状态变化

```typescript
import { MapEvent, MapStatusBundle } from "@bdmap/map"

controller.addEventListener(MapEvent.MAPSTATUSCHANGEFINISH, (result, reason) => {
  const status = result as MapStatusBundle
  // status.level - 缩放级别
  // status.rotation - 旋转角度
  // status.overlooking - 俯视角度
})
controller.addEventListener(MapEvent.MAPSTATUSCHANGESTART, () => {})
controller.addEventListener(MapEvent.MAPSTATUSCHANGE, (result, reason) => {})
```

### 地图POI点击

```typescript
import { IMapClickListener, MapClickObj } from "@bdmap/map"

class MyClickListener implements IMapClickListener {
  onClickedMapObj(arrClickObjs: Array<MapClickObj>) {
    // 点击POI、指南针等
  }
  onClickedBackground(x: number, y: number) {
    // 点击地图空白处
  }
}
this.mapController?.setMapClickListener(new MyClickListener())
```

## 常用类型

| 类型 | 说明 |
|------|------|
| `LatLng` | 经纬度坐标 |
| `PoiInfo` | POI信息（name, address, location） |
| `MapController` | 地图控制器 |
| `MapOptions` | 地图初始化选项 |
| `MapStatus` | 地图状态（zoom, center, rotate） |
| `Marker` | 标记覆盖物 |
| `ImageEntity` | 图片资源 |
| `SysEnum` | 系统枚举（地图类型、定位模式等） |

