import { afterEach, beforeEach, describe, expect, it } from '@ohos/hypium';
import { HarmonyTcpSocketFactory } from '../HarmonyTcpSocketFactory';
import { ITcpSocket } from '../ITcpSocket';
import util from '@ohos.util';

export default function harmonyTcpClientTest() {
  describe('harmonyTcpClientTest', () => {
    let tcpSocket: ITcpSocket;

    beforeEach(() => {
      tcpSocket = HarmonyTcpSocketFactory.createSocket();
    });

    afterEach(async () => {
      if (tcpSocket) {
        try {
          await tcpSocket.close();
        } catch (error) {
          // å¿½ç•¥å…³é—­æ—¶çš„é”™è¯¯
        }
      }
    });

    it('connect8888', 0, async () => {
      await tcpSocket.connect({
        address: 'localhost',
        port: 8888,
        timeout: 2000
      });

      console.log('âœ… æˆåŠŸè¿æ¥åˆ°8888ç«¯å£');

      // å¦‚æœè¿æ¥æˆåŠŸï¼Œå‘é€æµ‹è¯•æ¶ˆæ¯å¹¶ç­‰å¾…å›æ˜¾
      const testMessage = 'Hello Server!';
      const messageBytes = new util.TextEncoder().encode(testMessage);

      // åˆ›å»ºPromiseç­‰å¾…å›æ˜¾æ•°æ®
      const echoPromise = new Promise<string>((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('ç­‰å¾…å›æ˜¾è¶…æ—¶'));
        }, 3000);

        tcpSocket.on('message', (data: Uint8Array) => {
          clearTimeout(timeout);
          const echoText = new util.TextDecoder().decode(data);
          console.log('ğŸ“¨ æ”¶åˆ°å›æ˜¾æ•°æ®:', echoText);
          resolve(echoText);
        });
      });

      await tcpSocket.send(messageBytes);
      console.log('ğŸ“¤ å‘é€æ¶ˆæ¯:', testMessage);

      const echoText = await echoPromise;
      console.log('âœ… æ”¶åˆ°å›æ˜¾:', echoText);
      expect(echoText).assertEqual(testMessage);

      await tcpSocket.close();

    });
  });
}
